name: Deploy Flask App to 4 EC2 Instances

on:
  push:
    branches: [ main ]
    paths:
      # Se activa si hay cambios en el proyecto o el propio workflow
      - 'Proyecto_1_Diseno/**'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # Si un despliegue falla, los otros continuarÃ¡n.
      matrix:
        # Define las 4 instancias en las que se desplegarÃ¡
        instance: [1, 2, 3, 4]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to EC2 Instance ${{ matrix.instance }}
      env:
        # Selecciona los secretos de GitHub dinÃ¡micamente para cada instancia
        HOST: ${{ secrets[format('EC2_HOST_{0}', matrix.instance)] }}
        USER: ${{ secrets[format('EC2_USER_{0}', matrix.instance)] }}
        KEY: ${{ secrets[format('EC2_SSH_KEY_{0}', matrix.instance)] }}
        ENV_FILE: ${{ secrets[format('ENV_FILE_{0}', matrix.instance)] }}
      run: |
        echo "ğŸš€ Iniciando despliegue en la instancia ${{ matrix.instance }}..."
        
        # Crear el archivo de llave SSH temporalmente
        echo "$KEY" > deploy_key
        chmod 600 deploy_key
        
        # Crear archivo .env temporal localmente con el contenido real
        cat > temp_env_file << 'ENVEOF'
        $ENV_FILE
        ENVEOF
        
        # Script de despliegue remoto vÃ­a SSH
        ssh -o StrictHostKeyChecking=no -i deploy_key ${USER}@${HOST} '
          # 0. Usar la ubicaciÃ³n existente o crear nueva
          if [ -d "/home/ubuntu/Web-server-UDP" ]; then
            echo "ğŸ“ Usando proyecto existente en /home/ubuntu/Web-server-UDP"
            cd /home/ubuntu/Web-server-UDP
          else
            echo "ğŸ“ Creando nueva estructura en /opt/location-tracker"
            sudo mkdir -p /opt/location-tracker
            sudo chown $USER:$USER /opt/location-tracker
            cd /opt/location-tracker
          fi
          
          # 1. Actualizar el cÃ³digo desde el repositorio (clonar si es primera vez)
          echo "ğŸ“¦ Actualizando cÃ³digo desde Git..."
          if [ -d .git ]; then
            git pull origin main
          else
            git clone https://github.com/${{ github.repository }}.git .
          fi
          
          # 2. Navegar al directorio del proyecto
          cd Proyecto_1_Diseno
        '
        
        # 3. Transferir el archivo .env usando scp
        echo "âš™ï¸ Transfiriendo variables de entorno..."
        
        # Determinar la ruta correcta del proyecto
        PROJECT_PATH=$(ssh -o StrictHostKeyChecking=no -i deploy_key ${USER}@${HOST} '
          if [ -d "/home/ubuntu/Web-server-UDP/Proyecto_1_Diseno" ]; then
            echo "/home/ubuntu/Web-server-UDP/Proyecto_1_Diseno"
          else
            echo "/opt/location-tracker/Proyecto_1_Diseno"
          fi
        ')
        
        # Transferir archivo .env
        scp -o StrictHostKeyChecking=no -i deploy_key temp_env_file ${USER}@${HOST}:${PROJECT_PATH}/.env
        
        # Continuar con el resto del despliegue
        ssh -o StrictHostKeyChecking=no -i deploy_key ${USER}@${HOST} "
          # Ir al directorio del proyecto
          cd ${PROJECT_PATH}
          
          # 4. Verificar que el .env se transfiriÃ³ correctamente
          echo 'ğŸ“‹ Verificando archivo .env...'
          ls -la .env
          echo 'Contenido del .env:'
          cat .env
          
          # 5. Actualizar sistema e instalar Node.js si no estÃ¡ instalado
          echo 'ğŸ“¦ Verificando Node.js y npm...'
          if ! command -v node &> /dev/null; then
            echo 'Instalando Node.js...'
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          # 6. Instalar PM2 globalmente si no estÃ¡ instalado
          echo 'âš¡ Verificando PM2...'
          if ! command -v pm2 &> /dev/null; then
            echo 'Instalando PM2...'
            sudo npm install -g pm2
            
            # Configurar PM2 para iniciarse automÃ¡ticamente
            pm2 startup || true
            sudo env PATH=\$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u \$USER --hp /home/\$USER
          fi
          
          # 7. Instalar dependencias de Python con virtual environment
          echo 'ğŸ“‹ Configurando entorno virtual de Python...'
          sudo apt-get update
          sudo apt-get install -y python3-pip python3-venv nginx
          
          # Crear entorno virtual si no existe
          if [ ! -d 'venv' ]; then
            python3 -m venv venv
          fi
          
          # Activar entorno virtual e instalar dependencias
          source venv/bin/activate
          pip install flask psycopg2-binary python-dotenv
          
          # Si existe requirements.txt, instalarlo
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          
          # 8. Configurar Nginx como proxy reverso
          echo 'ğŸŒ Configurando Nginx proxy reverso...'
          sudo tee /etc/nginx/sites-available/location-tracker > /dev/null << 'NGINXEOF'
        server {
            listen 80;
            server_name _;
            
            location / {
                proxy_pass http://localhost:5000;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
            }
        }
        NGINXEOF
          
          # Habilitar el sitio de Nginx
          sudo ln -sf /etc/nginx/sites-available/location-tracker /etc/nginx/sites-enabled/default
          
          # Verificar configuraciÃ³n de Nginx
          sudo nginx -t
          
          # Reiniciar Nginx
          sudo systemctl restart nginx
          sudo systemctl enable nginx
          
          # 9. Detener aplicaciÃ³n anterior si existe
          echo 'ğŸ›‘ Deteniendo aplicaciÃ³n anterior...'
          pm2 stop flask-app-${{ matrix.instance }} 2>/dev/null || echo 'No hay aplicaciÃ³n anterior corriendo'
          pm2 delete flask-app-${{ matrix.instance }} 2>/dev/null || echo 'No hay aplicaciÃ³n anterior que eliminar'
          
          # 10. Crear script de inicio
          cat > start_app.sh << STARTEOF
            #!/bin/bash
            cd ${PROJECT_PATH}
            source venv/bin/activate
            python udp_flask_server.py
            STARTEOF
                    chmod +x start_app.sh
          
          # 11. Iniciar la aplicaciÃ³n con PM2 usando el script
          echo 'ğŸš€ Iniciando aplicaciÃ³n Flask con PM2...'
          pm2 start start_app.sh --name flask-app-${{ matrix.instance }}
          
          # 12. Guardar configuraciÃ³n de PM2
          pm2 save
          
          # 13. Verificar que el servicio estÃ¡ corriendo
          echo 'âœ… Verificando estado del servicio...'
          sleep 5
          pm2 status flask-app-${{ matrix.instance }}
          
          # 14. Ver logs si hay errores
          echo 'ğŸ“„ Ãšltimos logs de la aplicaciÃ³n:'
          pm2 logs flask-app-${{ matrix.instance }} --lines 10 --nostream || true
          
          # Test de conectividad
          echo 'ğŸ§ª Probando conectividad...'
          sleep 3
          curl -s http://localhost:5000/ > /dev/null && echo 'âœ… Flask respondiendo en puerto 5000' || echo 'âš ï¸  Flask no responde en puerto 5000'
          curl -s http://localhost/ > /dev/null && echo 'âœ… Nginx respondiendo en puerto 80' || echo 'âš ï¸  Nginx no responde en puerto 80'
          
          echo 'ğŸ‰ Despliegue completado en instancia ${{ matrix.instance }}'
          echo 'ğŸ“Š Estado final de PM2:'
          pm2 list
        "
        
        # Limpiar archivos temporales
        rm -f deploy_key temp_env_file