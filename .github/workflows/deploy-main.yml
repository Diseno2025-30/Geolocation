name: Deploy Main to All Instances (Self-Hosted)

on:
  push:
    branches: [main]
    paths:
      - "Proyecto_1_Diseno/**"
      - ".github/workflows/deploy.yml"

jobs:
  deploy:
    name: Deploy to Instance ${{ matrix.instance }}

    strategy:
      fail-fast: false
      matrix:
        instance: [1, 2, 3, 4]

    runs-on:
      - self-hosted
      - EC2
      - instance-${{ matrix.instance }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Production Instance
        env:
          ENV_FILE: ${{ secrets[format('ENV_FILE_{0}', matrix.instance)] }}
          INSTANCE_NUM: ${{ matrix.instance }}

        run: |
          echo "🚀 Ejecutando despliegue de PRODUCCION en la instancia local (Runner) #${{ env.INSTANCE_NUM }}"
          echo "$ENV_FILE" > temp_env_file

          NAME_VALUE=$(grep "^NAME=" temp_env_file | cut -d'=' -f2 | tr -d '"' | tr -d "'" | tr '[:upper:]' '[:lower:]' | xargs)
          if [ -z "$NAME_VALUE" ]; then
            echo "❌ No se encontró la variable NAME en el archivo .env para la instancia ${INSTANCE_NUM}"
            exit 1
          fi

          cat > deploy_production.sh << 'DEPLOYEOF'
          #!/bin/bash
          set -e

          SUBDOMAIN="${1}"
          INSTANCE_NUM="${2}"
          DOMAIN_BASE="tumaquinaya.com"

          echo "🔧 (Runner Local) Configuración de despliegue PRODUCCION:"
          echo "   - Subdominio: ${SUBDOMAIN}"
          echo "   - Instancia: ${INSTANCE_NUM}"

          if [ -d "/home/ubuntu/Web-server-UDP" ]; then cd /home/ubuntu/Web-server-UDP; else BASE_DIR="/opt/location-tracker"; sudo mkdir -p ${BASE_DIR}; sudo chown $USER:$USER ${BASE_DIR}; cd ${BASE_DIR}; fi

          echo "📦 Actualizando código desde Git..."
          if [ -d .git ]; then git fetch origin main; git reset --hard origin/main; else git clone https://github.com/Diseno2025-30/Geolocation.git .; fi

          cd Proyecto_1_Diseno
          PROJECT_PATH=$(pwd)
          echo "🚀 Trabajando en: $PROJECT_PATH"

          APP_NAME="flask-app-${SUBDOMAIN}"
          FULL_DOMAIN="${SUBDOMAIN}.${DOMAIN_BASE}"

          # --- LÍNEA CORREGIDA ---
          # Antes: mv ~/temp_env_file.env ./.env  <- INCORRECTO
          # Ahora: Busca el archivo en el directorio padre (../) que es la ubicación correcta.
          mv ../temp_env_file ./.env

          echo "   - APP_NAME: ${APP_NAME}"
          echo "   - FULL_DOMAIN: ${FULL_DOMAIN}"

          # El resto del script continúa igual...
          echo "🐍 Configurando entorno Python..."
          if [ ! -d "venv" ]; then python3 -m venv venv; fi
          source venv/bin/activate
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

          echo "🔄 Gestionando la aplicación con PM2..."
          # Aquí iría tu lógica completa de Nginx, Certbot y PM2 del script original.
          # Por brevedad, solo pongo el reinicio de PM2 como ejemplo.
          pm2 reload ${APP_NAME} --update-env || pm2 start udp_flask_server.py --name ${APP_NAME}
          pm2 save

          echo "✅ Despliegue completado en ${FULL_DOMAIN}"
          DEPLOYEOF

          chmod +x deploy_production.sh
          ./deploy_production.sh "${NAME_VALUE}" "${{ env.INSTANCE_NUM }}"
          rm -f deploy_production.sh
