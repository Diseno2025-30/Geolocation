name: Deploy Flask App to 4 EC2 Instances

on:
  push:
    branches: [ main ]
    paths:
      - 'Proyecto_1_Diseno/**'
      - '.github/workflows/deploy-main.yml'
      - '.github/scripts/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        instance: [1, 2, 3, 4]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to EC2 Instance ${{ matrix.instance }}
      env:
        HOST: ${{ secrets[format('EC2_HOST_{0}', matrix.instance)] }}
        USER: ${{ secrets[format('EC2_USER_{0}', matrix.instance)] }}
        KEY: ${{ secrets[format('EC2_SSH_KEY_{0}', matrix.instance)] }}
        ENV_FILE: ${{ secrets[format('ENV_FILE_{0}', matrix.instance)] }}
        DOMAIN_BASE: tumaquinaya.com
      run: |
        echo "üöÄ Iniciando despliegue en la instancia ${{ matrix.instance }}..."
        
        # Crear archivo de llave SSH
        echo "$KEY" > deploy_key
        chmod 600 deploy_key
        
        # Crear archivo .env temporal
        echo "$ENV_FILE" > temp_env_file
        
        # Extraer el NAME del archivo .env para usarlo como subdominio
        NAME_VALUE=$(grep "^NAME=" temp_env_file | cut -d'=' -f2 | tr -d '"' | tr -d "'" | tr '[:upper:]' '[:lower:]' | xargs)
        
        if [ -z "$NAME_VALUE" ]; then
            echo "‚ö†Ô∏è No se encontr√≥ NAME en .env, usando instance-${{ matrix.instance }}"
            NAME_VALUE="instance-${{ matrix.instance }}"
        fi
        
        FULL_DOMAIN="${NAME_VALUE}.${DOMAIN_BASE}"
        
        echo "üìã Configuraci√≥n detectada:"
        echo "   - NAME (subdominio): ${NAME_VALUE}"
        echo "   - Dominio completo: ${FULL_DOMAIN}"
        echo "   - IP del servidor: ${HOST}"
        
        # ========== SCRIPT OSRM - BARRANQUILLA OFICIAL ==========
        cat > setup_osrm.sh << 'OSRMEOF'
        #!/bin/bash
        set -e

        echo "üó∫Ô∏è ========================================="
        echo "üó∫Ô∏è CONFIGURANDO OSRM - BARRANQUILLA OFICIAL"
        echo "üó∫Ô∏è ========================================="

        # ========== VERIFICAR Y ELIMINAR MAPA ANTIGUO ==========
        echo "üîç Verificando mapa actual..."

        # Verificar si existe el mapa antiguo del puerto
        if [ -f "/opt/osrm-data/puerto-barranquilla.osrm" ] || docker ps 2>/dev/null | grep -q osrm-backend; then
          echo "üóëÔ∏è  Eliminando mapa antiguo del puerto y contenedor..."
          
          # Detener y eliminar contenedor
          docker stop osrm-backend 2>/dev/null || true
          docker rm osrm-backend 2>/dev/null || true
          
          # Eliminar archivos del mapa antiguo
          sudo rm -f /opt/osrm-data/puerto-barranquilla.*
          sudo rm -f /opt/osrm-data/barranquilla-oficial.* 2>/dev/null || true
          
          echo "‚úÖ Mapa antiguo y contenedor eliminados"
          FORCE_REINSTALL=true
        else
          echo "‚úÖ No se encontr√≥ mapa antiguo, procediendo con instalaci√≥n nueva"
          FORCE_REINSTALL=false
        fi

        echo "üì¶ Instalando dependencias..."

        # Instalar Docker si no est√° instalado
        if ! command -v docker &> /dev/null; then
          echo "üê≥ Instalando Docker..."
          sudo apt-get update -qq
          sudo apt-get install -y docker.io
          sudo systemctl start docker
          sudo systemctl enable docker
          echo "‚úÖ Docker instalado"
        else
          echo "‚úÖ Docker ya est√° instalado"
        fi

        # Instalar osmium-tool Y osmctools para convertir formatos
        if ! command -v osmium &> /dev/null; then
          echo "üîß Instalando osmium-tool y osmctools..."
          sudo apt-get update -qq
          sudo apt-get install -y osmium-tool osmctools
          echo "‚úÖ osmium-tool y osmctools instalados"
        else
          echo "‚úÖ osmium-tool ya est√° instalado"
          # Asegurar que osmctools tambi√©n est√© instalado
          if ! command -v osmconvert &> /dev/null; then
            echo "üîß Instalando osmctools..."
            sudo apt-get install -y osmctools
            echo "‚úÖ osmctools instalado"
          else
            echo "‚úÖ osmctools ya est√° instalado"
          fi
        fi

        # ========== PERMISOS DE DOCKER ==========
        echo "üîß Configurando permisos de Docker..."

        CURRENT_USER=$(whoami)
        echo "   Usuario detectado: ${CURRENT_USER}"

        if ! groups ${CURRENT_USER} | grep -q docker; then
          echo "   Agregando usuario '${CURRENT_USER}' al grupo docker..."
          sudo usermod -aG docker ${CURRENT_USER}
        else
          echo "   Usuario '${CURRENT_USER}' ya est√° en el grupo docker"
        fi

        echo "   Reiniciando Docker daemon..."
        sudo systemctl restart docker
        sleep 2

        sudo chmod 666 /var/run/docker.sock
        echo "‚úÖ Permisos de Docker configurados"
        # =========================================

        # Crear directorio para datos OSRM
        OSRM_DIR="/opt/osrm-data"
        echo "üìÅ Creando directorio: ${OSRM_DIR}"
        sudo mkdir -p ${OSRM_DIR}
        sudo chown ${CURRENT_USER}:${CURRENT_USER} ${OSRM_DIR}
        cd ${OSRM_DIR}

        echo ""
        echo "üì• ========================================="
        echo "üì• DESCARGANDO MAPA OFICIAL DE BARRANQUILLA"
        echo "üì• ========================================="
        echo ""
        echo "üó∫Ô∏è M√©todo: Relaci√≥n administrativa oficial"
        echo "   ID Relaci√≥n: 1335179"
        echo "   √Årea: 166 km¬≤ (Municipio completo)"
        echo "   Fuente: OpenStreetMap - Relaci√≥n oficial"
        echo ""

        # Limpiar descargas previas
        rm -f barranquilla-oficial.osm barranquilla-oficial.osm.pbf

        # Query de Overpass para obtener TODAS las calles dentro del l√≠mite oficial
        OVERPASS_QUERY='[out:xml][timeout:600];
        (
          relation(1335179);
          map_to_area;
          way(area)["highway"~"^(motorway|trunk|primary|secondary|tertiary|unclassified|residential|service|living_street|pedestrian|track|road)$"];
          >;
        );
        out body;'

        echo "$OVERPASS_QUERY" > /tmp/overpass_query.txt

        MAX_ATTEMPTS=3
        ATTEMPT=1

        echo "üåê Descargando mapa oficial de Barranquilla desde Overpass API..."
        echo "   (Esto puede tardar 2-5 minutos debido al √°rea completa)"
        echo ""

        until curl -L --connect-timeout 300 --max-time 600 \
          --retry 3 --retry-delay 15 \
          -d @/tmp/overpass_query.txt \
          "https://overpass-api.de/api/interpreter" \
          -o barranquilla-oficial.osm; do

          if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
            echo ""
            echo "‚ùå Error: No se pudo descargar desde Overpass API despu√©s de $MAX_ATTEMPTS intentos"
            echo "üí° Intentando m√©todo alternativo con bounding box..."
            
            # M√©todo alternativo: bounding box
            OVERPASS_QUERY_ALT='[out:xml][timeout:300][bbox:10.87,-74.93,11.08,-74.72];
            (
              way["highway"~"^(motorway|trunk|primary|secondary|tertiary|unclassified|residential|service|living_street|pedestrian|track|road)$"];
              >;
            );
            out body;'
            
            echo "$OVERPASS_QUERY_ALT" > /tmp/overpass_query_alt.txt
            
            curl -L --connect-timeout 300 --max-time 600 \
              -d @/tmp/overpass_query_alt.txt \
              "https://overpass-api.de/api/interpreter" \
              -o barranquilla-oficial.osm
            break
          fi
          
          echo ""
          echo "‚ö†Ô∏è Intento $ATTEMPT de $MAX_ATTEMPTS fall√≥"
          echo "   Esperando 30 segundos antes de reintentar..."
          ATTEMPT=$((ATTEMPT+1))
          sleep 30
          rm -f barranquilla-oficial.osm
        done

        # Verificar que el archivo se descarg√≥ correctamente
        if [ ! -f "barranquilla-oficial.osm" ] || [ ! -s "barranquilla-oficial.osm" ]; then
          echo "‚ùå Error: No se pudo descargar el mapa de Barranquilla"
          echo "üí° Intentando descargar Colombia completo y extraer Barranquilla..."
          
          wget -O colombia-latest.osm.pbf https://download.geofabrik.de/south-america/colombia-latest.osm.pbf
          
          # Bounding box basada en la relaci√≥n oficial
          osmium extract --bbox -74.93,10.87,-74.72,11.08 colombia-latest.osm.pbf -o barranquilla-oficial.osm.pbf
          rm -f colombia-latest.osm.pbf
          
          if [ -f "barranquilla-oficial.osm.pbf" ]; then
            echo "‚úÖ Mapa descargado y extra√≠do exitosamente"
            SKIP_CONVERSION=true
          else
            echo "‚ùå Error cr√≠tico: No se pudo obtener el mapa de Barranquilla"
            exit 1
          fi
        else
          echo "‚úÖ Descarga completada exitosamente"
          
          # Verificar que el archivo no est√© vac√≠o
          FILE_SIZE=$(stat -c%s barranquilla-oficial.osm 2>/dev/null || stat -f%z barranquilla-oficial.osm)
          if [ $FILE_SIZE -lt 100000 ]; then
            echo "‚ö†Ô∏è Archivo muy peque√±o ($FILE_SIZE bytes), probablemente vac√≠o"
            echo "üí° Usando m√©todo alternativo..."
            rm -f barranquilla-oficial.osm
            
            wget -O colombia-latest.osm.pbf https://download.geofabrik.de/south-america/colombia-latest.osm.pbf
            osmium extract --bbox -74.93,10.87,-74.72,11.08 colombia-latest.osm.pbf -o barranquilla-oficial.osm.pbf
            rm -f colombia-latest.osm.pbf
            SKIP_CONVERSION=true
          else
            # Convertir OSM a PBF
            echo ""
            echo "üîÑ Convirtiendo formato OSM a PBF..."
            
            if command -v osmconvert &> /dev/null; then
              echo "   Usando osmconvert (recomendado para archivos grandes)..."
              osmconvert barranquilla-oficial.osm -o=barranquilla-oficial.osm.pbf
            else
              echo "   Usando osmium como fallback..."
              osmium cat barranquilla-oficial.osm -o barranquilla-oficial.osm.pbf --overwrite --input-format=xml,add_metadata=false
            fi
            
            if [ ! -f "barranquilla-oficial.osm.pbf" ]; then
              echo "‚ùå Error en conversi√≥n"
              exit 1
            fi
            
            rm -f barranquilla-oficial.osm
            echo "‚úÖ Conversi√≥n completada"
            SKIP_CONVERSION=false
          fi
        fi

        # ========== PROCESAR CON OSRM ==========
        echo ""
        echo "‚öôÔ∏è ========================================="
        echo "‚öôÔ∏è PROCESANDO MAPA CON OSRM"
        echo "‚öôÔ∏è ========================================="
        echo ""
        echo "   Algoritmo: MLD (Multi-Level Dijkstra)"
        echo "   Perfil: Car (autom√≥viles)"
        echo "   Tiempo estimado: 3-8 minutos"
        echo ""

        echo "üìç Paso 1/3: Extracci√≥n de datos de rutas..."
        if ! docker run -t -v "${PWD}:/data" ghcr.io/project-osrm/osrm-backend \
          osrm-extract -p /opt/car.lua /data/barranquilla-oficial.osm.pbf; then
          echo "‚ùå Error en extracci√≥n OSRM"
          echo "üí° Verifica los logs arriba para m√°s detalles"
          exit 1
        fi
        echo "‚úÖ Extracci√≥n completada"

        echo ""
        echo "üóÇÔ∏è Paso 2/3: Particionamiento de grafo..."
        if ! docker run -t -v "${PWD}:/data" ghcr.io/project-osrm/osrm-backend \
          osrm-partition /data/barranquilla-oficial.osrm; then
          echo "‚ùå Error en particionamiento OSRM"
          exit 1
        fi
        echo "‚úÖ Particionamiento completado"

        echo ""
        echo "üé® Paso 3/3: Personalizaci√≥n de rutas..."
        if ! docker run -t -v "${PWD}:/data" ghcr.io/project-osrm/osrm-backend \
          osrm-customize /data/barranquilla-oficial.osrm; then
          echo "‚ùå Error en personalizaci√≥n OSRM"
          exit 1
        fi
        echo "‚úÖ Personalizaci√≥n completada"

        echo ""
        echo "‚úÖ Procesamiento OSRM completado exitosamente"

        # Limpiar archivo .osm.pbf para ahorrar espacio
        echo ""
        echo "üßπ Limpiando archivos temporales..."
        rm -f barranquilla-oficial.osm.pbf /tmp/overpass_query.txt /tmp/overpass_query_alt.txt

        echo ""
        echo "üíæ Espacio utilizado:"
        du -sh ${OSRM_DIR}

        echo ""
        echo "üöÄ ========================================="
        echo "üöÄ INICIANDO SERVIDOR OSRM"
        echo "üöÄ ========================================="

        # Detener contenedor anterior si existe
        docker stop osrm-backend 2>/dev/null || true
        docker rm osrm-backend 2>/dev/null || true

        # Iniciar servidor OSRM en puerto 5001
        echo "   Puerto: 5001"
        echo "   Algoritmo: MLD"
        echo "   Auto-reinicio: Habilitado"
        echo ""

        docker run -d --name osrm-backend \
          --restart unless-stopped \
          -p 5001:5000 \
          -v "${PWD}:/data" \
          ghcr.io/project-osrm/osrm-backend \
          osrm-routed --algorithm mld /data/barranquilla-oficial.osrm

        # Esperar a que OSRM est√© listo
        echo "‚è≥ Esperando que OSRM est√© listo..."
        for i in {1..30}; do
          if curl -s -f "http://localhost:5001/nearest/v1/driving/-74.81,10.99" > /dev/null 2>&1; then
            echo ""
            echo "‚úÖ OSRM est√° funcionando correctamente"
            break
          fi
          if [ $i -eq 30 ]; then
            echo ""
            echo "‚ùå Timeout esperando OSRM. Ver logs:"
            docker logs osrm-backend --tail 50
            exit 1
          fi
          echo -n "."
          sleep 3
        done

        echo ""
        echo "üîß Configurando servicio systemd para auto-inicio..."

        # Crear servicio systemd
        sudo tee /etc/systemd/system/osrm.service > /dev/null << SERVICEEOF
        [Unit]
        Description=OSRM Backend Service - Barranquilla Oficial
        After=docker.service
        Requires=docker.service

        [Service]
        Type=simple
        User=${CURRENT_USER}
        Restart=always
        RestartSec=10
        ExecStartPre=-/usr/bin/docker stop osrm-backend
        ExecStartPre=-/usr/bin/docker rm osrm-backend
        ExecStart=/usr/bin/docker run --rm --name osrm-backend -p 5001:5000 -v ${OSRM_DIR}:/data ghcr.io/project-osrm/osrm-backend osrm-routed --algorithm mld /data/barranquilla-oficial.osrm
        ExecStop=/usr/bin/docker stop osrm-backend

        [Install]
        WantedBy=multi-user.target
        SERVICEEOF

        sudo systemctl daemon-reload
        sudo systemctl enable osrm

        echo "‚úÖ Servicio systemd configurado"

        echo ""
        echo "========================================="
        echo "‚úÖ OSRM CONFIGURADO EXITOSAMENTE"
        echo "========================================="
        echo ""
        echo "üìä INFORMACI√ìN DEL SISTEMA:"
        echo "   - Contenedor: osrm-backend"
        echo "   - Puerto: 5001 (host) ‚Üí 5000 (contenedor)"
        echo "   - Datos: ${OSRM_DIR}"
        echo "   - √Årea: Barranquilla Oficial (166 km¬≤)"
        echo "   - Servicio systemd: Habilitado"
        echo ""
        echo "üó∫Ô∏è COBERTURA DEL MAPA:"
        echo "   ‚úÖ Todo el municipio de Barranquilla"
        echo "   ‚úÖ Todas las v√≠as principales y secundarias"
        echo "   ‚úÖ Calles residenciales"
        echo "   ‚úÖ V√≠as de servicio"
        echo ""
        echo "üõ†Ô∏è COMANDOS √öTILES:"
        echo "   - Ver logs: docker logs -f osrm-backend"
        echo "   - Reiniciar: docker restart osrm-backend"
        echo "   - Estado: docker ps | grep osrm"
        echo "   - Detener: docker stop osrm-backend"
        echo "   - Servicio: sudo systemctl status osrm"
        echo "========================================="
        OSRMEOF
        
        # ========== SCRIPT DE DESPLIEGUE REMOTO ==========
        cat > deploy_remote.sh << 'DEPLOYEOF'
        #!/bin/bash
        set -e
        
        # Recibir par√°metros
        SUBDOMAIN="${1}"
        DOMAIN_BASE="${2}"
        INSTANCE_NUM="${3}"
        
        echo "üîß Configuraci√≥n de despliegue:"
        echo "   - Subdominio: ${SUBDOMAIN}"
        echo "   - Dominio base: ${DOMAIN_BASE}"
        echo "   - Instancia: ${INSTANCE_NUM}"
        
        # Determinar ruta base del proyecto
        if [ -d "/home/ubuntu/Web-server-UDP" ]; then
          BASE_DIR="/home/ubuntu/Web-server-UDP"
        else
          BASE_DIR="/opt/location-tracker"
          sudo mkdir -p ${BASE_DIR}
          sudo chown $USER:$USER ${BASE_DIR}
        fi
        
        cd "${BASE_DIR}"
        
        echo "üìÅ Directorio base: ${BASE_DIR}"
        
        # Actualizar o clonar el c√≥digo de main
        if [ -d .git ]; then
          echo "üì¶ Actualizando c√≥digo desde main..."
          git fetch origin main
          git checkout main
          git reset --hard origin/main
          CODE_UPDATED=true
        else
          echo "üì• Clonando repositorio main..."
          git clone https://github.com/Diseno2025-30/Geolocation.git .
          CODE_UPDATED=true
        fi
        
        # Navegar al directorio del proyecto
        cd Proyecto_1_Diseno
        PROJECT_PATH=$(pwd)
        
        echo "üìÇ Proyecto en: ${PROJECT_PATH}"
        
        # Configurar permisos para Nginx
        echo "üîí Configurando permisos para Nginx..."
        chmod o+rx ${BASE_DIR}
        chmod o+rx ${PROJECT_PATH}
        
        if [ -d "static" ]; then
          find static -type d -exec chmod o+rx {} \;
          find static -type f -exec chmod o+r {} \;
          echo "‚úÖ Permisos configurados para carpeta static"
        fi
        
        # Asegurar que el .env est√© en su lugar
        if [ -f "/tmp/test_env_file" ]; then
          echo "üìã Moviendo archivo .env..."
          mv /tmp/test_env_file .env
        fi
        
        FULL_DOMAIN="${SUBDOMAIN}.${DOMAIN_BASE}"
        APP_NAME="flask-app-${SUBDOMAIN}"
        
        echo "üìä Configuraci√≥n:"
        echo "   - APP_NAME: ${APP_NAME}"
        echo "   - Puerto: 5000"
        echo "   - Proyecto: ${PROJECT_PATH}"
        
        # Instalar dependencias
        echo "üì¶ Instalando dependencias..."
        sudo apt-get update -qq
        sudo apt-get install -y python3-pip python3-venv nginx
        
        # PM2 si no est√° instalado
        if ! command -v pm2 &> /dev/null; then
          if ! command -v node &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          sudo npm install -g pm2
          pm2 startup systemd -u $USER --hp /home/$USER
        fi
        
        # Configurar entorno virtual de Python
        echo "üêç Configurando entorno Python..."
        if [ ! -d "venv" ]; then
          python3 -m venv venv
        fi
        
        source venv/bin/activate
        pip install --upgrade pip
        pip install flask psycopg2-binary python-dotenv requests
        
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        
        # Detener aplicaci√≥n anterior si existe
        pm2 stop ${APP_NAME} 2>/dev/null || true
        pm2 delete ${APP_NAME} 2>/dev/null || true
        
        # Liberar puerto
        sudo fuser -k 5000/tcp 2>/dev/null || true
        sleep 2
        
        # Crear script de inicio
        cat > start_app.sh << STARTSCRIPT
        #!/bin/bash
        cd "\$(dirname "\$0")"
        source venv/bin/activate
        export FLASK_APP=udp_flask_server.py
        export FLASK_ENV=production
        python udp_flask_server.py --port 5000
        STARTSCRIPT
        chmod +x start_app.sh
        
        # Configurar Nginx
        echo "üåê Configurando Nginx..."
        
        # Crear configuraci√≥n de Nginx
        sudo tee /etc/nginx/sites-available/location-tracker > /dev/null << NGINXCONF
        server {
            listen 80;
            server_name ${FULL_DOMAIN} www.${FULL_DOMAIN};
            
            location / {
                proxy_pass http://localhost:5000;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                proxy_connect_timeout 60s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
                proxy_buffering off;
            }
            
            location /osrm/ {
                proxy_pass http://localhost:5001/;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                rewrite ^/osrm/(.*) /\$1 break;
            }
            
            location /static {
                alias ${PROJECT_PATH}/static;
                expires 30d;
                add_header Cache-Control "public, immutable";
            }
        }
        NGINXCONF
        
        sudo ln -sf /etc/nginx/sites-available/location-tracker /etc/nginx/sites-enabled/
        sudo rm -f /etc/nginx/sites-enabled/default
        
        # Verificar y recargar Nginx
        if sudo nginx -t; then
          sudo systemctl reload nginx
          echo "‚úÖ Nginx configurado correctamente"
        else
          echo "‚ùå Error en configuraci√≥n de Nginx"
          exit 1
        fi
        
        # Iniciar aplicaci√≥n con PM2
        echo "üöÄ Iniciando aplicaci√≥n..."
        pm2 start start_app.sh \
          --name ${APP_NAME} \
          --interpreter bash \
          --cwd ${PROJECT_PATH}
        
        pm2 save
        
        # Esperar y verificar
        echo "‚è≥ Esperando inicio de la aplicaci√≥n..."
        sleep 5
        
        # Verificaci√≥n
        echo "üìä Estado de la aplicaci√≥n:"
        pm2 status ${APP_NAME}
        
        # Test de conectividad
        echo "üß™ Probando aplicaci√≥n..."
        if curl -s -f http://localhost:5000/ > /dev/null 2>&1; then
          echo "‚úÖ Aplicaci√≥n respondiendo en puerto 5000"
        else
          echo "‚ö†Ô∏è La aplicaci√≥n no responde"
          pm2 logs ${APP_NAME} --lines 20 --nostream
        fi
        
        # Resumen final
        echo ""
        echo "========================================="
        echo "üéâ APLICACI√ìN DESPLEGADA EXITOSAMENTE"
        echo "========================================="
        echo ""
        echo "üìä INFORMACI√ìN:"
        echo "   - Instancia EC2: ${INSTANCE_NUM}"
        echo "   - Aplicaci√≥n PM2: ${APP_NAME}"
        echo "   - Puerto interno: 5000"
        echo "   - OSRM: http://localhost:5001 (Barranquilla Oficial)"
        echo ""
        echo "üîó URLS:"
        echo "   - Producci√≥n: http://${FULL_DOMAIN}/"
        echo "   - OSRM API: http://${FULL_DOMAIN}/osrm/"
        echo ""
        echo "üìç ENDPOINTS:"
        echo "   - http://${FULL_DOMAIN}/coordenadas"
        echo "   - http://${FULL_DOMAIN}/database"
        echo "   - http://${FULL_DOMAIN}/version"
        echo "   - http://${FULL_DOMAIN}/health"
        echo ""
        echo "üõ†Ô∏è COMANDOS √öTILES:"
        echo "   - Ver logs: pm2 logs ${APP_NAME}"
        echo "   - Reiniciar: pm2 restart ${APP_NAME}"
        echo "   - Estado: pm2 status"
        echo "   - OSRM logs: docker logs -f osrm-backend"
        echo ""
        echo "üó∫Ô∏è OSRM configurado para Barranquilla Oficial"
        echo "   M√©todo: Relaci√≥n administrativa completa"
        echo "   Cobertura: 166 km¬≤ (municipio completo)"
        echo "========================================="
        DEPLOYEOF
        
        # Transferir scripts
        echo "üì§ Transfiriendo archivos al servidor..."
        scp -o StrictHostKeyChecking=no -i deploy_key setup_osrm.sh ${USER}@${HOST}:/tmp/
        scp -o StrictHostKeyChecking=no -i deploy_key temp_env_file ${USER}@${HOST}:/tmp/test_env_file
        scp -o StrictHostKeyChecking=no -i deploy_key deploy_remote.sh ${USER}@${HOST}:/tmp/
        
        # Ejecutar instalaci√≥n de OSRM PRIMERO
        echo ""
        echo "üó∫Ô∏è ========================================="
        echo "üó∫Ô∏è PASO 1: CONFIGURAR OSRM"
        echo "üó∫Ô∏è ========================================="
        ssh -o StrictHostKeyChecking=no -i deploy_key ${USER}@${HOST} \
          "chmod +x /tmp/setup_osrm.sh && /tmp/setup_osrm.sh"
        
        # Ejecutar despliegue de la aplicaci√≥n
        echo ""
        echo "üöÄ ========================================="
        echo "üöÄ PASO 2: DESPLEGAR APLICACI√ìN"
        echo "üöÄ ========================================="
        ssh -o StrictHostKeyChecking=no -i deploy_key ${USER}@${HOST} \
          "chmod +x /tmp/deploy_remote.sh && \
           /tmp/deploy_remote.sh '${NAME_VALUE}' '${DOMAIN_BASE}' '${{ matrix.instance }}' && \
           rm -f /tmp/deploy_remote.sh /tmp/setup_osrm.sh"
        
        # Limpiar archivos temporales locales
        rm -f deploy_key temp_env_file deploy_remote.sh setup_osrm.sh
        
        echo "‚úÖ Despliegue con SSL/HTTPS completado para instancia ${{ matrix.instance }}"
