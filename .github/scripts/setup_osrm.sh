#!/bin/bash
set -e

echo "üó∫Ô∏è ========================================="
echo "üó∫Ô∏è CONFIGURANDO OSRM - BARRANQUILLA OFICIAL"
echo "üó∫Ô∏è ========================================="

# VERIFICAR SI EL MAPA ACTUAL ES EL CORRECTO
OSRM_DIR="/opt/osrm-data"
CURRENT_MAP="$OSRM_DIR/barranquilla-oficial.osrm"

# Si existe el contenedor pero NO existe el mapa nuevo, forzar reinstalaci√≥n
if docker ps 2>/dev/null | grep -q osrm-backend && [ ! -f "$CURRENT_MAP" ]; then
    echo "üîÑ Contenedor OSRM corriendo pero con mapa antiguo. Forzando reinstalaci√≥n..."
    docker stop osrm-backend 2>/dev/null || true
    docker rm osrm-backend 2>/dev/null || true
    sudo rm -f $OSRM_DIR/puerto-barranquilla.*
    FORCE_REINSTALL=true
elif docker ps 2>/dev/null | grep -q osrm-backend && [ -f "$CURRENT_MAP" ]; then
    echo "‚úÖ OSRM ya est√° corriendo con mapa de Barranquilla oficial"
    docker ps | grep osrm-backend
    echo ""
    echo "üß™ Probando conectividad OSRM..."
    if curl -s -f http://localhost:5001/nearest/v1/driving/-74.8,10.98 > /dev/null 2>&1; then
        echo "‚úÖ OSRM responde correctamente"
    else
        echo "‚ö†Ô∏è OSRM no responde, reiniciando..."
        docker restart osrm-backend
        sleep 5
    fi
    exit 0
else
    echo "üÜï Instalando OSRM desde cero..."
    FORCE_REINSTALL=true
fi

echo "üì¶ Instalando dependencias..."

# Instalar Docker si no est√° instalado
if ! command -v docker &> /dev/null; then
  echo "üê≥ Instalando Docker..."
  sudo apt-get update -qq
  sudo apt-get install -y docker.io
  sudo systemctl start docker
  sudo systemctl enable docker
  echo "‚úÖ Docker instalado"
else
  echo "‚úÖ Docker ya est√° instalado"
fi

# Instalar osmium-tool Y osmctools para convertir formatos
if ! command -v osmium &> /dev/null; then
  echo "üîß Instalando osmium-tool y osmctools..."
  sudo apt-get update -qq
  sudo apt-get install -y osmium-tool osmctools
  echo "‚úÖ osmium-tool y osmctools instalados"
else
  echo "‚úÖ osmium-tool ya est√° instalado"
  # Asegurar que osmctools tambi√©n est√© instalado
  if ! command -v osmconvert &> /dev/null; then
    echo "üîß Instalando osmctools..."
    sudo apt-get install -y osmctools
    echo "‚úÖ osmctools instalado"
  else
    echo "‚úÖ osmctools ya est√° instalado"
  fi
fi

# ========== PERMISOS DE DOCKER ==========
echo "üîß Configurando permisos de Docker..."

CURRENT_USER=$(whoami)
echo "   Usuario detectado: ${CURRENT_USER}"

if ! groups ${CURRENT_USER} | grep -q docker; then
  echo "   Agregando usuario '${CURRENT_USER}' al grupo docker..."
  sudo usermod -aG docker ${CURRENT_USER}
else
  echo "   Usuario '${CURRENT_USER}' ya est√° en el grupo docker"
fi

echo "   Reiniciando Docker daemon..."
sudo systemctl restart docker
sleep 2

sudo chmod 666 /var/run/docker.sock
echo "‚úÖ Permisos de Docker configurados"
# =========================================

# Crear directorio para datos OSRM
OSRM_DIR="/opt/osrm-data"
echo "üìÅ Creando directorio: ${OSRM_DIR}"
sudo mkdir -p ${OSRM_DIR}
sudo chown ${CURRENT_USER}:${CURRENT_USER} ${OSRM_DIR}
cd ${OSRM_DIR}

# ========== VERIFICAR Y ELIMINAR MAPA ANTIGUO ==========
echo "üîç Verificando mapa actual..."

# Verificar si existe el mapa antiguo del puerto
if [ -f "/opt/osrm-data/puerto-barranquilla.osrm" ] || docker ps 2>/dev/null | grep -q osrm-backend; then
  echo "üóëÔ∏è  Eliminando mapa antiguo del puerto y contenedor..."
  
  # Detener y eliminar contenedor
  docker stop osrm-backend 2>/dev/null || true
  docker rm osrm-backend 2>/dev/null || true
  
  # Eliminar archivos del mapa antiguo
  sudo rm -f /opt/osrm-data/puerto-barranquilla.*
  sudo rm -f /opt/osrm-data/barranquilla-oficial.* 2>/dev/null || true
  
  echo "‚úÖ Mapa antiguo y contenedor eliminados"
  FORCE_REINSTALL=true
else
  echo "‚úÖ No se encontr√≥ mapa antiguo, procediendo con instalaci√≥n nueva"
  FORCE_REINSTALL=false
fi

echo ""
echo "üì• ========================================="
echo "üì• DESCARGANDO MAPA OFICIAL DE BARRANQUILLA"
echo "üì• ========================================="
echo ""
echo "üó∫Ô∏è M√©todo: Relaci√≥n administrativa oficial"
echo "   ID Relaci√≥n: 1335179"
echo "   √Årea: 166 km¬≤ (Municipio completo)"
echo "   Fuente: OpenStreetMap - Relaci√≥n oficial"
echo ""

# Limpiar descargas previas
rm -f barranquilla-oficial.osm barranquilla-oficial.osm.pbf

# Query de Overpass CORREGIDA para obtener TODAS las calles dentro del l√≠mite oficial de Barranquilla
OVERPASS_QUERY='[out:xml][timeout:600];
(
  relation(1335179);
  map_to_area;
  way(area)["highway"~"^(motorway|trunk|primary|secondary|tertiary|unclassified|residential|service|living_street|pedestrian|track|road)$"];
  >;
);
out body;'

echo "$OVERPASS_QUERY" > /tmp/overpass_query.txt

MAX_ATTEMPTS=3
ATTEMPT=1

echo "üåê Descargando mapa oficial de Barranquilla desde Overpass API..."
echo "   (Esto puede tardar 2-5 minutos debido al √°rea completa)"
echo ""

until curl -L --connect-timeout 300 --max-time 600 \
  --retry 3 --retry-delay 15 \
  -d @/tmp/overpass_query.txt \
  "https://overpass-api.de/api/interpreter" \
  -o barranquilla-oficial.osm; do

  if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
    echo ""
    echo "‚ùå Error: No se pudo descargar desde Overpass API despu√©s de $MAX_ATTEMPTS intentos"
    echo "üí° Intentando m√©todo alternativo con bounding box..."
    
    # M√©todo alternativo: bounding box conservadora basada en la relaci√≥n
    OVERPASS_QUERY_ALT='[out:xml][timeout:300][bbox:10.87,-74.93,11.08,-74.72];
    (
      way["highway"~"^(motorway|trunk|primary|secondary|tertiary|unclassified|residential|service|living_street|pedestrian|track|road)$"];
      >;
    );
    out body;'
    
    echo "$OVERPASS_QUERY_ALT" > /tmp/overpass_query_alt.txt
    
    curl -L --connect-timeout 300 --max-time 600 \
      -d @/tmp/overpass_query_alt.txt \
      "https://overpass-api.de/api/interpreter" \
      -o barranquilla-oficial.osm
    break
  fi
  
  echo ""
  echo "‚ö†Ô∏è Intento $ATTEMPT de $MAX_ATTEMPTS fall√≥"
  echo "   Esperando 30 segundos antes de reintentar..."
  ATTEMPT=$((ATTEMPT+1))
  sleep 30
  rm -f barranquilla-oficial.osm
done

# Verificar que el archivo se descarg√≥ correctamente
if [ ! -f "barranquilla-oficial.osm" ] || [ ! -s "barranquilla-oficial.osm" ]; then
  echo "‚ùå Error: No se pudo descargar el mapa de Barranquilla"
  echo "üí° Intentando descargar Colombia completo y extraer Barranquilla..."
  
  wget -O colombia-latest.osm.pbf https://download.geofabrik.de/south-america/colombia-latest.osm.pbf
  
  # Bounding box basada en la relaci√≥n oficial (aproximada)
  osmium extract --bbox -74.93,10.87,-74.72,11.08 colombia-latest.osm.pbf -o barranquilla-oficial.osm.pbf
  rm -f colombia-latest.osm.pbf
  
  # Si usamos PBF directamente, saltar conversi√≥n
  if [ -f "barranquilla-oficial.osm.pbf" ]; then
    echo "‚úÖ Mapa descargado y extra√≠do exitosamente"
    echo "   Archivo PBF: $(ls -lh barranquilla-oficial.osm.pbf | awk '{print $5}')"
    SKIP_CONVERSION=true
  else
    echo "‚ùå Error cr√≠tico: No se pudo obtener el mapa de Barranquilla"
    exit 1
  fi
else
  echo "‚úÖ Descarga completada exitosamente"
  echo "   Archivo OSM: $(ls -lh barranquilla-oficial.osm | awk '{print $5}')"
  
  # Verificar que el archivo no est√© vac√≠o
  FILE_SIZE=$(stat -c%s barranquilla-oficial.osm 2>/dev/null || stat -f%z barranquilla-oficial.osm)
  if [ $FILE_SIZE -lt 100000 ]; then
    echo "‚ö†Ô∏è Archivo muy peque√±o ($FILE_SIZE bytes), probablemente vac√≠o"
    echo "üí° Usando m√©todo alternativo..."
    rm -f barranquilla-oficial.osm
    
    # Descargar Colombia completo
    wget -O colombia-latest.osm.pbf https://download.geofabrik.de/south-america/colombia-latest.osm.pbf
    osmium extract --bbox -74.93,10.87,-74.72,11.08 colombia-latest.osm.pbf -o barranquilla-oficial.osm.pbf
    rm -f colombia-latest.osm.pbf
    SKIP_CONVERSION=true
  else
    # Convertir OSM a PBF usando osmconvert (m√°s robusto que osmium para archivos grandes)
    echo ""
    echo "üîÑ Convirtiendo formato OSM a PBF..."
    
    # Usar osmconvert que es m√°s robusto con archivos grandes y complejos
    if command -v osmconvert &> /dev/null; then
      echo "   Usando osmconvert (recomendado para archivos grandes)..."
      osmconvert barranquilla-oficial.osm -o=barranquilla-oficial.osm.pbf
    else
      echo "   Usando osmium como fallback..."
      osmium cat barranquilla-oficial.osm -o barranquilla-oficial.osm.pbf --overwrite --input-format=xml,add_metadata=false
    fi
    
    if [ ! -f "barranquilla-oficial.osm.pbf" ]; then
      echo "‚ùå Error en conversi√≥n"
      exit 1
    fi
    
    rm -f barranquilla-oficial.osm
    echo "‚úÖ Conversi√≥n completada"
    echo "   Archivo PBF: $(ls -lh barranquilla-oficial.osm.pbf | awk '{print $5}')"
    SKIP_CONVERSION=false
  fi
fi

# ========== PROCESAR CON OSRM ==========
echo ""
echo "‚öôÔ∏è ========================================="
echo "‚öôÔ∏è PROCESANDO MAPA CON OSRM"
echo "‚öôÔ∏è ========================================="
echo ""
echo "   Algoritmo: MLD (Multi-Level Dijkstra)"
echo "   Perfil: Car (autom√≥viles)"
echo "   Tiempo estimado: 3-8 minutos"
echo ""

echo "üìç Paso 1/3: Extracci√≥n de datos de rutas..."
if ! docker run -t -v "${PWD}:/data" ghcr.io/project-osrm/osrm-backend \
  osrm-extract -p /opt/car.lua /data/barranquilla-oficial.osm.pbf; then
  echo "‚ùå Error en extracci√≥n OSRM"
  echo "üí° Verifica los logs arriba para m√°s detalles"
  exit 1
fi
echo "‚úÖ Extracci√≥n completada"

echo ""
echo "üóÇÔ∏è Paso 2/3: Particionamiento de grafo..."
if ! docker run -t -v "${PWD}:/data" ghcr.io/project-osrm/osrm-backend \
  osrm-partition /data/barranquilla-oficial.osrm; then
  echo "‚ùå Error en particionamiento OSRM"
  exit 1
fi
echo "‚úÖ Particionamiento completado"

echo ""
echo "üé® Paso 3/3: Personalizaci√≥n de rutas..."
if ! docker run -t -v "${PWD}:/data" ghcr.io/project-osrm/osrm-backend \
  osrm-customize /data/barranquilla-oficial.osrm; then
  echo "‚ùå Error en personalizaci√≥n OSRM"
  exit 1
fi
echo "‚úÖ Personalizaci√≥n completada"

echo ""
echo "‚úÖ Procesamiento OSRM completado exitosamente"

# Limpiar archivo .osm.pbf para ahorrar espacio
echo ""
echo "üßπ Limpiando archivos temporales..."
rm -f barranquilla-oficial.osm.pbf /tmp/overpass_query.txt /tmp/overpass_query_alt.txt

echo ""
echo "üíæ Espacio utilizado:"
du -sh ${OSRM_DIR}
echo ""
echo "üìÇ Archivos finales:"
ls -lh ${OSRM_DIR}/ | grep barranquilla-oficial

echo ""
echo "üöÄ ========================================="
echo "üöÄ INICIANDO SERVIDOR OSRM"
echo "üöÄ ========================================="

# Detener contenedor anterior si existe
docker stop osrm-backend 2>/dev/null || true
docker rm osrm-backend 2>/dev/null || true

# Iniciar servidor OSRM en puerto 5001
echo "   Puerto: 5001"
echo "   Algoritmo: MLD"
echo "   Auto-reinicio: Habilitado"
echo ""

docker run -d --name osrm-backend \
  --restart unless-stopped \
  -p 5001:5000 \
  -v "${PWD}:/data" \
  ghcr.io/project-osrm/osrm-backend \
  osrm-routed --algorithm mld /data/barranquilla-oficial.osrm

# Esperar a que OSRM est√© listo
echo "‚è≥ Esperando que OSRM est√© listo..."
MAX_RETRIES=10
RETRY=0
OSRM_READY=false

while [ $RETRY -lt $MAX_RETRIES ]; do
  if curl -s -f http://localhost:5001/nearest/v1/driving/-74.8,10.98 > /dev/null 2>&1; then
    echo "‚úÖ OSRM responde correctamente"
    OSRM_READY=true
    break
  else
    RETRY=$((RETRY + 1))
    if [ $RETRY -lt $MAX_RETRIES ]; then
      echo "‚è≥ Esperando a OSRM (intento $RETRY/$MAX_RETRIES)..."
      sleep 2
    fi
  fi
done

if [ "$OSRM_READY" = false ]; then
  echo "‚ùå OSRM no responde despu√©s de $MAX_RETRIES intentos"
  echo "Logs del contenedor:"
  docker logs osrm-backend
  exit 1
fi

# Test adicional de routing
echo "üß™ Probando endpoint de routing..."
TEST_RESULT=$(curl -s "http://localhost:5001/route/v1/driving/-74.8,10.98;-74.79,10.99?overview=false")

if echo "$TEST_RESULT" | grep -q "\"code\":\"Ok\""; then
  echo "‚úÖ Endpoint de routing funciona correctamente"
else
  echo "‚ö†Ô∏è Advertencia: Endpoint de routing no responde como se esperaba"
  echo "Respuesta: $TEST_RESULT"
fi

# Prueba final exhaustiva
echo ""
echo "üß™ ========================================="
echo "üß™ PRUEBA EXHAUSTIVA DE SNAP-TO-ROADS"
echo "üß™ ========================================="
echo ""

# Probar con diferentes ubicaciones representativas de Barranquilla
TEST_POINTS=(
  "-74.7818,10.9876"  # Centro Hist√≥rico
  "-74.8065,10.9352"  # Suroriente
  "-74.8250,10.9630"  # Suroccidente
  "-74.7523,10.9741"  # Norte - Riomar
  "-74.7889,10.9198"  # Sur - Las Nieves
)

echo "üìç Probando snap-to-roads en 5 ubicaciones clave:"
for point in "${TEST_POINTS[@]}"; do
  lon=$(echo $point | cut -d',' -f1)
  lat=$(echo $point | cut -d',' -f2)
  echo ""
  echo "   Ubicaci√≥n: ($lat, $lon)"
  RESPONSE=$(curl -s "http://localhost:5001/nearest/v1/driving/$lon,$lat")
  
  if echo "$RESPONSE" | grep -q '"code":"Ok"'; then
    SNAPPED_LAT=$(echo "$RESPONSE" | grep -o '"location":\[[^]]*\]' | head -1 | grep -o '[0-9.-]*' | tail -1)
    SNAPPED_LON=$(echo "$RESPONSE" | grep -o '"location":\[[^]]*\]' | head -1 | grep -o '[0-9.-]*' | head -1)
    DISTANCE=$(echo "$RESPONSE" | grep -o '"distance":[0-9.-]*' | head -1 | grep -o '[0-9.-]*')
    
    echo "   ‚úÖ Ajustado a: ($SNAPPED_LAT, $SNAPPED_LON)"
    echo "   üìè Distancia: ${DISTANCE}m"
  else
    echo "   ‚ùå No se pudo ajustar (fuera del mapa)"
  fi
done

echo ""
echo "üîß Configurando servicio systemd para auto-inicio..."

# Crear servicio systemd
sudo tee /etc/systemd/system/osrm.service > /dev/null << SERVICEEOF
[Unit]
Description=OSRM Backend Service - Barranquilla Oficial
After=docker.service
Requires=docker.service

[Service]
Type=simple
User=${CURRENT_USER}
Restart=always
RestartSec=10
ExecStartPre=-/usr/bin/docker stop osrm-backend
ExecStartPre=-/usr/bin/docker rm osrm-backend
ExecStart=/usr/bin/docker run --rm --name osrm-backend -p 5001:5000 -v ${OSRM_DIR}:/data ghcr.io/project-osrm/osrm-backend osrm-routed --algorithm mld /data/barranquilla-oficial.osrm
ExecStop=/usr/bin/docker stop osrm-backend

[Install]
WantedBy=multi-user.target
SERVICEEOF

sudo systemctl daemon-reload
sudo systemctl enable osrm

echo "‚úÖ Servicio systemd configurado"

echo ""
echo "========================================="
echo "üéâ OSRM CONFIGURADO EXITOSAMENTE"
echo "========================================="
echo ""
echo "üìä INFORMACI√ìN:"
echo "   - √Årea: Barranquilla Oficial (166 km¬≤)"
echo "   - M√©todo: Relaci√≥n administrativa completa"
echo "   - Puerto: 5001 (interno: 5000)"
echo "   - Contenedor: osrm-backend"
echo "   - Estado: Corriendo"
echo "   - Servicio systemd: Habilitado"
echo ""
echo "üó∫Ô∏è COBERTURA DEL MAPA:"
echo "   ‚úÖ Todo el municipio de Barranquilla"
echo "   ‚úÖ Todas las v√≠as principales y secundarias"
echo "   ‚úÖ Calles residenciales"
echo "   ‚úÖ V√≠as de servicio"
echo ""
echo "üîó ENDPOINTS DISPONIBLES:"
echo "   - /nearest - Punto m√°s cercano en red"
echo "   - /route - Ruta entre puntos"
echo "   - /match - Map matching"
echo "   - /table - Matriz de distancias"
echo ""
echo "üß™ TEST:"
echo "   curl http://localhost:5001/nearest/v1/driving/-74.8,10.98"
echo ""
echo "üõ†Ô∏è COMANDOS √öTILES:"
echo "   - Ver logs: docker logs -f osrm-backend"
echo "   - Reiniciar: docker restart osrm-backend"
echo "   - Detener: docker stop osrm-backend"
echo "   - Estado: docker ps | grep osrm"
echo "   - Servicio: sudo systemctl status osrm"
echo "========================================"