<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Coordinate Tracker Pv2</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #00ff00;
        }
        .coordinates {
            font-size: 18px;
            margin: 10px 0;
        }
        .field {
            margin: 5px 0;
        }
        .label {
            display: inline-block;
            width: 120px;
            color: #ffffff;
        }
        .value {
            color: #00ff00;
            font-weight: bold;
        }
        .offline {
            color: #ff0000;
        }
        .online {
            color: #00ff00;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <div class="container">
        <h1>Real-time Coordinate Tracker</h1>

        <div class="status">
            <div class="field">
                <span class="label">Status:</span>
                <span id="status" class="value online">ONLINE</span>
            </div>
            <div class="field">
                <span class="label">Last Update:</span>
                <span id="lastUpdate" class="value">Never</span>
            </div>
        </div>

        <h2>Ubicación</h2>
        <div id="map" style="height: 500px; width: 100%;"></div>

        <div class="coordinates">
            <h2>Current Position</h2>
            <div class="field">
                <span class="label">Latitude:</span>
                <span id="latitude" class="value">---.------</span>
            </div>
            <div class="field">
                <span class="label">Longitude:</span>
                <span id="longitude" class="value">---.------</span>
            </div>
            <div class="field">
                <span class="label">Device ID:</span>
                <span id="deviceId" class="value">---</span>
            </div>
            <div class="field">
                <span class="label">Timestamp:</span>
                <span id="timestamp" class="value">---</span>
            </div>
        </div>
    </div>
    <script>
    // --- Variables globales ---
    var map = L.map('map').setView([11.0, -74.8], 13); // Coordenadas iniciales y zoom
    var marker = L.marker([11.0, -74.8]).addTo(map); // Marcador inicial
    var polyline = L.polyline([], { color: '#00ff00' }).addTo(map); // Polilínea para la trayectoria
    var coordinatesHistory = []; // Array para almacenar el historial de coordenadas

    // Capa base del mapa (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- Funciones ---

    // Actualiza la posición del marcador y el centro del mapa
    function updateMarkerAndMap(lat, lon) {
        marker.setLatLng([lat, lon]);
        map.setView([lat, lon], 15); // Centra y hace zoom al nuevo punto
    }

    // Agrega una nueva coordenada al historial y actualiza la polilínea
    function addCoordinateToHistory(lat, lon) {
        coordinatesHistory.push([lat, lon]); // Agrega el nuevo punto al historial

        // Si hay suficientes puntos, ajusta el mapa para que se vean todos
        if (coordinatesHistory.length > 1) {
            map.fitBounds(polyline.setLatLngs(coordinatesHistory).getBounds());
        } else {
            // Si es el primer punto, solo actualiza el marcador y el mapa
            updateMarkerAndMap(lat, lon);
        }
    }

    // Función para obtener las coordenadas desde el backend
    async function fetchCoordinates() {
        try {
            // Usamos la ruta directa a tu API Flask
            const response = await fetch("/coordenadas");
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            // Asegúrate de que data.lat y data.lon existen antes de usarlos
            if (data && data.lat !== undefined && data.lon !== undefined) {
                const lat = data.lat;
                const lon = data.lon;

                // Actualiza los elementos de texto en la página
                latitudeElement.textContent = lat.toFixed(6);
                longitudeElement.textContent = lon.toFixed(6);
                deviceIdElement.textContent = data.source || '---';
                timestampElement.textContent = data.timestamp || '---';

                // Actualiza el estado y la última actualización
                lastUpdateElement.textContent = new Date().toLocaleTimeString();
                setOnlineStatus(true);

                // Agrega la nueva coordenada al historial y dibuja la línea
                addCoordinateToHistory(lat, lon);

            } else {
                // Si no hay datos o están incompletos, marca como offline
                setOnlineStatus(false);
                console.warn("Received incomplete data:", data);
            }
        } catch (error) {
            console.error("Error fetching coordinates:", error);
            setOnlineStatus(false);
        }
    }

    // --- Inicialización ---

    // Llamar a fetchCoordinates() al inicio para obtener la primera posición
    fetchCoordinates();

    // Actualizar cada 2 segundos (2000 milisegundos)
    setInterval(fetchCoordinates, 2000);

    // La función actualizarPosicion() que tenías antes ya no es necesaria,
    // ya que la lógica se integra en fetchCoordinates y addCoordinateToHistory.
    </script>
    
</body>
</html>