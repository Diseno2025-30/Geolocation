<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Coordinate Tracker Oliver</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #000;
            color: #00ff00;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #00ff00;
        }
        .coordinates {
            font-size: 18px;
            margin: 10px 0;
        }
        .field {
            margin: 5px 0;
        }
        .label {
            display: inline-block;
            width: 120px;
            color: #ffffff;
        }
        .value {
            color: #00ff00;
            font-weight: bold;
        }
        .offline {
            color: #ff0000;
        }
        .online {
            color: #00ff00;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
    <div class="container">
        <h1>Real-time Coordinate Tracker</h1>

        <div class="status">
            <div class="field">
                <span class="label">Status:</span>
                <span id="status" class="value online">ONLINE</span>
            </div>
            <div class="field">
                <span class="label">Last Update:</span>
                <span id="lastUpdate" class="value">Never</span>
            </div>
        </div>

        <h2>Ubicación</h2>
        <div id="map" style="height: 500px; width: 100%;"></div>

        <div class="coordinates">
            <h2>Current Position</h2>
            <div class="field">
                <span class="label">Latitude:</span>
                <span id="latitude" class="value">---.------</span>
            </div>
            <div class="field">
                <span class="label">Longitude:</span>
                <span id="longitude" class="value">---.------</span>
            </div>
            <div class="field">
                <span class="label">Device ID:</span>
                <span id="deviceId" class="value">---</span>
            </div>
            <div class="field">
                <span class="label">Timestamp:</span>
                <span id="timestamp" class="value">---</span>
            </div>
        </div>
    </div>
    <script>
        // DOM elements
        const statusElement = document.getElementById('status');
        const lastUpdateElement = document.getElementById('lastUpdate');
        const latitudeElement = document.getElementById('latitude');
        const longitudeElement = document.getElementById('longitude');
        const deviceIdElement = document.getElementById('deviceId');
        const timestampElement = document.getElementById('timestamp');

        // Function to update display with new coordinate data
        function updateDisplay(data) {
            // Asegúrate de que los datos existen y no están vacíos
            if (data && Object.keys(data).length > 0) {
                // Accede directamente a las propiedades del objeto 'data'
                latitudeElement.textContent = data.lat ? data.lat.toFixed(6) : '---.------';
                longitudeElement.textContent = data.lon ? data.lon.toFixed(6) : '---.------';
                deviceIdElement.textContent = data.source || '---';
                timestampElement.textContent = data.timestamp || '---';

                lastUpdateElement.textContent = new Date().toLocaleTimeString();
                setOnlineStatus(true);
            } else {
                 // Si no hay datos, muestra que está offline
                setOnlineStatus(false);
                latitudeElement.textContent = '---.------';
                longitudeElement.textContent = '---.------';
                deviceIdElement.textContent = '---';
                timestampElement.textContent = '---';
            }
        }

        // Function to set online/offline status
        function setOnlineStatus(online) {
            statusElement.textContent = online ? 'ONLINE' : 'OFFLINE';
            statusElement.className = online ? 'value online' : 'value offline';
        }

        // Function to fetch latest coordinates from server
        async function fetchCoordinates() {
            try {
                const response = await fetch('/coordenadas');
                if (response.ok) {
                    const data = await response.json();
                    updateDisplay(data);
                    setOnlineStatus(true);
                    fetchCoordinates(); // Fetch again immediately
                } else {
                    setOnlineStatus(false);
                    setTimeout(fetchCoordinates, 5000);
                }
            } catch (error) {
                console.error('Error fetching coordinates:', error);
                setOnlineStatus(false);
                setTimeout(fetchCoordinates, 5000);
            }
        }

        // Initial fetch
        fetchCoordinates();
    </script>
    <script>
        var map = L.map('map').setView([11.0, -74.8], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        var marker = L.marker([11.0, -74.8]).addTo(map);

        function actualizarPosicion() {
        fetch("/coordenadas")
            .then(res => res.json())
            .then(data => {
            var lat = data.lat;
            var lon = data.lon;

            marker.setLatLng([lat, lon]);
            map.setView([lat, lon], 15);
            })
            .catch(err => console.error("Error obteniendo coordenadas:", err));
        }

        actualizarPosicion();
        setInterval(actualizarPosicion, 10000);
    </script>

</body>
</html>