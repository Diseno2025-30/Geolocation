<!-- templates/rutas.html -->
{% extends "_base.html" %}

{% block title %}Gesti√≥n de Rutas{% endblock %}

{% block page_css %}
<!-- CSS simplificado -->
<link rel="stylesheet" href="{{ get_static_path('css/rutas-simple.css') }}" />

<!-- CSS TEMPORAL para debugging del modal -->
<style>
/* TEMPORAL: Forzar visibilidad del modal */
#rutaModal {
    /* Quitar cualquier display:none que pueda venir de otros CSS */
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background-color: rgba(0, 0, 0, 0.7) !important;
    z-index: 9998 !important;
    align-items: center !important;
    justify-content: center !important;
}

#rutaModal .modal-content {
    background: white !important;
    padding: 30px !important;
    border-radius: 15px !important;
    max-width: 700px !important;
    width: 90% !important;
    max-height: 90vh !important;
    overflow-y: auto !important;
    z-index: 9999 !important;
    box-shadow: 0 0 30px rgba(0,0,0,0.5) !important;
    border: 3px solid red !important; /* Rojo para debug */
}

/* Elementos de info del mapa (si existen) */
#mapInfo {
    position: absolute;
    top: 20px;
    right: 20px;
    background: white;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 1000;
}
</style>
{% endblock %}

{% block page_name %}Gesti√≥n de Rutas Preestablecidas{% endblock %}

{% block main_content %}
<div class="rutas-container">
  <!-- Panel de Control -->
  <div class="control-panel">
    <div class="panel-header">
      <h2>Panel de Control</h2>
    </div>
    
    <div class="panel-section">
      <h3>Filtrar por Empresa</h3>
      <select id="empresaSelector" class="form-input">
        <option value="">Todas las empresas</option>
      </select>
    </div>

    <div class="panel-section">
      <h3>Rutas Disponibles</h3>
      <div id="rutasList" class="rutas-list">
        <p>Cargando rutas...</p>
      </div>
    </div>

    <div class="panel-section">
      <button id="btnCrearRuta" class="btn-primary" style="background: #2196f3; color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold;">
        Ôºã Crear Nueva Ruta
      </button>
    </div>
  </div>

  <!-- Mapa -->
  <div class="map-section">
    <div id="map" class="map-container"></div>
    
    <!-- Info del mapa (si existe en tu dise√±o original) -->
    <div id="mapInfo" style="display: none;">
      <div class="info-item">
        <span class="info-label">Ruta Seleccionada:</span>
        <span id="selectedRutaName" class="info-value">Ninguna</span>
      </div>
      <div class="info-item">
        <span class="info-label">Empresa:</span>
        <span id="selectedRutaEmpresa" class="info-value">---</span>
      </div>
      <div class="info-item">
        <span class="info-label">Segmentos:</span>
        <span id="selectedRutaSegments" class="info-value">0</span>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Crear/Editar Ruta -->
<div id="rutaModal" class="modal" style="display: none;">
  <div class="modal-content">
    <button class="modal-close" id="closeRutaModal" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
    <h3 id="modalTitle" style="margin-top: 0;">Crear Nueva Ruta</h3>
    
    <div id="segmentSelectionInfo" class="segment-selection-info" style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
      <h4 style="margin-top: 0; color: #1976d2;">Selecci√≥n de Segmentos</h4>
      <p>Haz clic en el mapa para seleccionar segmentos de calle.</p>
      <p>Cada segmento aparecer√° en el mapa con un n√∫mero.</p>
      <p style="color: #d32f2f; font-weight: bold;">DEBUG: El modal deber√≠a ser visible ahora</p>
    </div>
    
    <form id="rutaForm">
      <div class="form-group" style="margin-bottom: 20px;">
        <label for="rutaNombre" style="display: block; margin-bottom: 5px; font-weight: bold;">Nombre de la Ruta *</label>
        <input type="text" id="rutaNombre" class="form-input" required placeholder="Ej: Ruta Principal" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
      </div>
      
      <div class="form-group" style="margin-bottom: 20px;">
        <label for="rutaEmpresa" style="display: block; margin-bottom: 5px; font-weight: bold;">Empresa *</label>
        <select id="rutaEmpresa" class="form-input" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
          <option value="">Seleccione una empresa</option>
        </select>
      </div>
      
      <div class="form-group" style="margin-bottom: 20px;">
        <label for="rutaDescripcion" style="display: block; margin-bottom: 5px; font-weight: bold;">Descripci√≥n</label>
        <textarea id="rutaDescripcion" class="form-input" rows="3" placeholder="Descripci√≥n opcional" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
      </div>
      
      <div class="form-group" style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <label style="font-weight: bold;">Segmentos de Calle</label>
          <button type="button" id="btnLimpiarSegmentos" class="btn-secondary" style="padding: 6px 12px; font-size: 12px; background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            Limpiar
          </button>
        </div>
        <div class="segments-container" style="border: 2px dashed #ddd; border-radius: 8px; padding: 15px; min-height: 100px;">
          <p class="segments-placeholder" id="segmentsPlaceholder" style="color: #888; text-align: center; margin: 0; padding: 20px;">
            Haga clic en el mapa para seleccionar segmentos
          </p>
          <div id="selectedSegmentsList" class="selected-segments-list" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-top: 10px;"></div>
        </div>
        <div style="text-align: right; margin-top: 8px; font-size: 14px;">
          <span id="segmentCount" style="font-weight: bold;">0</span> segmentos seleccionados
        </div>
      </div>
      
      <div class="form-actions" style="display: flex; gap: 10px; margin-top: 30px;">
        <button type="button" class="btn-secondary" id="cancelRutaBtn" style="flex: 1; background: #f5f5f5; color: #333; border: 1px solid #ddd; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold;">
          Cancelar
        </button>
        <button type="submit" class="btn-primary" id="saveRutaBtn" style="flex: 1; background: #4caf50; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold;">
          Guardar Ruta
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Debugging visual temporal -->
<div id="debugInfo" style="
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.85);
    color: #0f0;
    padding: 10px;
    border-radius: 5px;
    z-index: 99999;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    border: 2px solid #0f0;
    min-width: 300px;
">
    <div style="margin-bottom: 5px; font-weight: bold;">üöÄ DEBUG CONSOLE</div>
    <div>Estado: <span id="debugText" style="color: #ff0;">Listo</span></div>
    <div>Modal: <span id="debugModal" style="color: #f0f">Oculto</span></div>
    <div id="debugClickInfo" style="margin-top: 5px; font-size: 10px; color: #0ff;">Haz clic en alg√∫n lugar...</div>
</div>

<script>
// Script temporal para debugging - se ejecuta inmediatamente
(function() {
    console.log("üî¥ DEBUG SCRIPT INICIADO");
    
    const debugText = document.getElementById('debugText');
    const debugModal = document.getElementById('debugModal');
    const debugClickInfo = document.getElementById('debugClickInfo');
    
    // Actualizar estado del modal
    function updateModalStatus() {
        const modal = document.getElementById('rutaModal');
        if (modal) {
            const isVisible = modal.style.display !== 'none' && 
                             window.getComputedStyle(modal).display !== 'none';
            debugModal.textContent = isVisible ? 'VISIBLE üü¢' : 'OCULTO üî¥';
            debugModal.style.color = isVisible ? '#0f0' : '#f0f';
        }
    }
    
    // Verificar cada segundo
    setInterval(updateModalStatus, 1000);
    
    // Trackear clicks
    document.addEventListener('click', function(e) {
        if (debugText) {
            let targetInfo = '';
            if (e.target.id) targetInfo = `#${e.target.id}`;
            else if (e.target.className) targetInfo = `.${e.target.className}`;
            else targetInfo = e.target.tagName;
            
            debugText.textContent = `Click: ${targetInfo}`;
            debugText.style.color = '#ff0';
            
            if (debugClickInfo) {
                debugClickInfo.textContent = `Coords: ${e.clientX}, ${e.clientY}`;
            }
        }
        
        // Si se hace click en btnCrearRuta
        if (e.target.id === 'btnCrearRuta' || e.target.closest('#btnCrearRuta')) {
            console.log("üî¥ DEBUG: Click en btnCrearRuta detectado por script inline");
            
            // Forzar mostrar modal despu√©s de 100ms (para ver si JS lo est√° ocultando)
            setTimeout(() => {
                const modal = document.getElementById('rutaModal');
                if (modal) {
                    console.log("üî¥ DEBUG: Mostrando modal forzadamente");
                    modal.style.display = 'flex';
                    modal.style.backgroundColor = 'rgba(255,0,0,0.1)';
                    
                    // Agregar borde verde para confirmar
                    modal.querySelector('.modal-content').style.border = '5px solid #0f0';
                    
                    updateModalStatus();
                }
            }, 100);
        }
        
        // Si se hace click en cerrar modal
        if (e.target.id === 'closeRutaModal' || e.target.id === 'cancelRutaBtn') {
            setTimeout(updateModalStatus, 100);
        }
    });
    
    // Tambi√©n trackear eventos del teclado
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('rutaModal');
            if (modal && modal.style.display !== 'none') {
                modal.style.display = 'none';
                updateModalStatus();
            }
        }
        
        // Atajo de teclado para mostrar modal: Ctrl+M
        if (e.ctrlKey && e.key === 'm') {
            e.preventDefault();
            const modal = document.getElementById('rutaModal');
            if (modal) {
                modal.style.display = 'flex';
                updateModalStatus();
                console.log("üî¥ DEBUG: Modal mostrado con Ctrl+M");
            }
        }
    });
    
    console.log("‚úÖ DEBUG SCRIPT LISTO");
})();
</script>
{% endblock %}

{% block page_js %}
<script type="module" src="{{ get_static_path('js/rutas.js') }}"></script>
{% endblock %}