<!-- templates/rutas.html -->
{% extends "_base.html" %}

{% block title %}Gesti√≥n de Rutas{% endblock %}

{% block page_css %}
<!-- CSS simplificado -->
<link rel="stylesheet" href="{{ get_static_path('css/rutas-simple.css') }}" />

<!-- CSS ESPEC√çFICO para el modal de pantalla completa -->
<style>
/* ==================== MODAL DE PANTALLA COMPLETA ==================== */
#rutaModal {
    display: none; /* Se mostrar√° con JS */
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: white; /* Fondo blanco s√≥lido */
    z-index: 10000;
    overflow: hidden;
    flex-direction: column;
}

#rutaModal .modal-header {
    padding: 20px;
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

#rutaModal .modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
    color: white;
}

#rutaModal .modal-close {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

#rutaModal .modal-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
}

#rutaModal .modal-body {
    flex: 1;
    display: flex;
    overflow: hidden;
    padding: 0;
}

/* Panel principal con mapa */
#rutaModal .modal-main-content {
    flex: 3;
    display: flex;
    flex-direction: column;
    padding: 20px;
}

/* Mapa dentro del modal */
#modalMap {
    flex: 1;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    min-height: 400px;
}

/* Panel lateral para segmentos */
#rutaModal .modal-sidebar {
    flex: 1;
    min-width: 350px;
    max-width: 400px;
    background: #f8f9fa;
    padding: 20px;
    overflow-y: auto;
    border-left: 1px solid #ddd;
    display: flex;
    flex-direction: column;
}

/* Info de selecci√≥n */
.segment-selection-info {
    background: #e3f2fd;
    border: 2px solid #2196f3;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}

.segment-selection-info h4 {
    margin-top: 0;
    color: #1976d2;
}

/* Lista de segmentos */
.selected-segments-container {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.selected-segments-list {
    flex: 1;
    overflow-y: auto;
    border: 2px dashed #ddd;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    background: white;
    min-height: 200px;
}

.segments-placeholder {
    color: #888;
    text-align: center;
    margin: 0;
    padding: 30px 15px;
    font-style: italic;
}

.segment-list-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 10px;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    transition: all 0.3s;
}

.segment-list-item:hover {
    border-color: #2196f3;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
}

.segment-index {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    margin-right: 12px;
    flex-shrink: 0;
}

.segment-details {
    flex: 1;
    min-width: 0; /* Para que el texto no desborde */
}

.segment-street {
    font-weight: bold;
    color: #333;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.segment-id {
    font-size: 12px;
    color: #666;
    font-family: 'Courier New', monospace;
    background: #f5f5f5;
    padding: 2px 6px;
    border-radius: 4px;
    display: inline-block;
}

.segment-remove-btn {
    background: #f44336;
    color: white;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.3s;
}

.segment-remove-btn:hover {
    background: #d32f2f;
    transform: scale(1.1);
}

/* Bot√≥n limpiar segmentos */
.btn-clear-segments {
    background: #ff9800;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    width: 100%;
    margin-top: 10px;
    transition: all 0.3s;
}

.btn-clear-segments:hover {
    background: #f57c00;
    transform: translateY(-2px);
}

/* Formulario en la parte inferior */
.modal-form-container {
    padding: 20px;
    background: #f8f9fa;
    border-top: 1px solid #ddd;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 0;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #333;
}

.form-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: all 0.3s;
}

.form-input:focus {
    border-color: #2196f3;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    outline: none;
}

textarea.form-input {
    min-height: 100px;
    resize: vertical;
}

/* Botones del formulario */
.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
}

.btn-secondary, .btn-primary {
    padding: 12px 30px;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
    font-size: 16px;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-2px);
}

.btn-primary {
    background: #4caf50;
    color: white;
}

.btn-primary:hover {
    background: #388e3c;
    transform: translateY(-2px);
}

/* Contador de segmentos */
.segments-counter {
    text-align: center;
    margin-top: 10px;
    font-size: 14px;
    color: #666;
}

.segments-counter span {
    font-weight: bold;
    color: #2196f3;
    background: rgba(33, 150, 243, 0.1);
    padding: 2px 8px;
    border-radius: 12px;
}

/* Responsive */
@media (max-width: 1024px) {
    #rutaModal .modal-body {
        flex-direction: column;
    }
    
    #rutaModal .modal-sidebar {
        min-width: 100%;
        max-width: 100%;
        border-left: none;
        border-top: 1px solid #ddd;
        max-height: 300px;
    }
    
    #modalMap {
        min-height: 300px;
    }
}

@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .btn-secondary, .btn-primary {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block page_name %}Gesti√≥n de Rutas Preestablecidas{% endblock %}

{% block main_content %}
<div class="rutas-container">
  <!-- Panel de Control -->
  <div class="control-panel">
    <div class="panel-header">
      <h2>Panel de Control</h2>
    </div>
    
    <div class="panel-section">
      <h3>Filtrar por Empresa</h3>
      <select id="empresaSelector" class="form-input">
        <option value="">Todas las empresas</option>
      </select>
    </div>

    <div class="panel-section">
      <h3>Rutas Disponibles</h3>
      <div id="rutasList" class="rutas-list">
        <p>Cargando rutas...</p>
      </div>
    </div>

    <div class="panel-section">
      <button id="btnCrearRuta" class="btn-primary" style="background: #2196f3; color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold;">
        Ôºã Crear Nueva Ruta
      </button>
    </div>
  </div>

  <!-- Mapa principal (fuera del modal) -->
  <div class="map-section">
    <div id="map" class="map-container"></div>
    
    <!-- Info del mapa -->
    <div id="mapInfo" style="position: absolute; top: 20px; right: 20px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000;">
      <div class="info-item">
        <span class="info-label">Ruta Seleccionada:</span>
        <span id="selectedRutaName" class="info-value">Ninguna</span>
      </div>
      <div class="info-item">
        <span class="info-label">Empresa:</span>
        <span id="selectedRutaEmpresa" class="info-value">---</span>
      </div>
      <div class="info-item">
        <span class="info-label">Segmentos:</span>
        <span id="selectedRutaSegments" class="info-value">0</span>
      </div>
    </div>
  </div>
</div>

<!-- Modal de pantalla completa -->
<div id="rutaModal" class="modal"  style="display: none;">
  <div class="modal-header">
    <h3 id="modalTitle">Crear Nueva Ruta</h3>
    <button class="modal-close" id="closeRutaModal">&times;</button>
  </div>
  
  <div class="modal-body">
    <!-- Panel principal con mapa -->
    <div class="modal-main-content">
      <!-- Informaci√≥n de selecci√≥n -->
      <div id="segmentSelectionInfo" class="segment-selection-info">
        <h4>Selecci√≥n de Segmentos</h4>
        <p>Haz clic en el mapa para seleccionar segmentos de calle en orden.</p>
        <p>Los segmentos aparecer√°n en el mapa con n√∫meros y se agregar√°n a la lista lateral.</p>
      </div>
      
      <!-- Mapa dentro del modal -->
      <div id="modalMap"></div>
    </div>
    
    <!-- Panel lateral para segmentos -->
    <div class="modal-sidebar">
      <div class="selected-segments-container">
        <h4 style="margin-top: 0; margin-bottom: 15px;">Segmentos Seleccionados</h4>
        
        <div id="selectedSegmentsList" class="selected-segments-list">
          <p class="segments-placeholder" id="segmentsPlaceholder">
            Haz clic en el mapa para comenzar<br>
            Los segmentos aparecer√°n aqu√≠
          </p>
        </div>
        
        <div class="segments-counter">
          <span id="segmentCount">0</span> segmentos seleccionados
        </div>
        
        <button type="button" id="btnLimpiarSegmentos" class="btn-clear-segments">
          üóëÔ∏è Limpiar Todos los Segmentos
        </button>
      </div>
    </div>
  </div>
  
  <!-- Formulario en la parte inferior -->
  <div class="modal-form-container">
    <form id="rutaForm">
      <div class="form-grid">
        <div class="form-group">
          <label for="rutaNombre">Nombre de la Ruta *</label>
          <input type="text" id="rutaNombre" class="form-input" required placeholder="Ej: Ruta Principal Centro">
        </div>
        
        <div class="form-group">
          <label for="rutaEmpresa">Empresa *</label>
          <select id="rutaEmpresa" class="form-input" required>
            <option value="">Seleccione una empresa</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="rutaDescripcion">Descripci√≥n</label>
          <textarea id="rutaDescripcion" class="form-input" rows="2" placeholder="Descripci√≥n opcional de la ruta"></textarea>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn-secondary" id="cancelRutaBtn">Cancelar</button>
        <button type="submit" class="btn-primary" id="saveRutaBtn">Guardar Ruta</button>
      </div>
    </form>
  </div>
</div>

<!-- Debugging visual -->
<div id="debugInfo" style="position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: #0f0; padding: 10px; border-radius: 5px; z-index: 99999; font-family: monospace; font-size: 12px; border: 2px solid #0f0;">
  <div>DEBUG: Modal: <span id="debugModal">‚ùå</span></div>
  <div>Segmentos: <span id="debugSegments">0</span></div>
</div>
{% endblock %}

{% block page_js %}
<script type="module" src="{{ get_static_path('js/rutas.js') }}"></script>
{% endblock %}